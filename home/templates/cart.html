{% extends 'base.html' %}
{% load static %}

{% block title %}Carrito - EntertainPet{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mt-4" style="color:var(--marron-oscuro)">Tu cesta</h2>

  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="cart-page">
    <section>
      <div class="cart-list">
        {% if cart_items %}
          {% for item in cart_items %}
            <div class="cart-item">
              <div class="mini-img">
                {% if item.producto.imagenes.first %}
                  <img src="{{ item.producto.imagenes.first.imagen }}" alt="{{ item.producto.nombre }}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">
                {% else %}
                  üñºÔ∏è
                {% endif %}
              </div>
              
              <div class="meta">
                <h5>{{ item.producto.nombre }}</h5>
                
                {% if item.talla_producto %}
                  <p style="color:#666;font-size:0.9rem;margin:4px 0;">
                    Talla: <strong>{{ item.talla_producto.talla }}</strong>
                  </p>
                {% endif %}
                
                <div class="price">{{ item.producto.precio_final }} ‚Ç¨</div>
                <div style="font-size:0.85rem;color:var(--gris);">
                  Subtotal: <strong>{{ item.subtotal }} ‚Ç¨</strong>
                </div>
              </div>
              
              <div class="controls">
                <label style="font-weight:600;margin-bottom:8px;display:block;">Cantidad</label>
                
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                  {# BOT√ìN DISMINUIR #}
                  {% if item.id %}
                    {# Usuario autenticado #}
                    <form method="post" action="{% url 'home:carrito_update' item.id %}" style="display:inline;">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="decrease">
                      <button type="submit" class="btn-cantidad-cart">‚àí</button>
                    </form>
                  {% else %}
                    {# Usuario invitado (sesi√≥n) - usar formulario inline con JavaScript #}
                    <button type="button" class="btn-cantidad-cart" onclick="updateSessionCart('{{ item.key }}', 'decrease')">‚àí</button>
                  {% endif %}
                  
                  <span style="font-size:18px;font-weight:600;min-width:40px;text-align:center;">{{ item.cantidad }}</span>
                  
                  {# BOT√ìN AUMENTAR #}
                  {% if item.id %}
                    {# Usuario autenticado #}
                    <form method="post" action="{% url 'home:carrito_update' item.id %}" style="display:inline;">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="increase">
                      <button type="submit" class="btn-cantidad-cart">+</button>
                    </form>
                  {% else %}
                    {# Usuario invitado (sesi√≥n) #}
                    <button type="button" class="btn-cantidad-cart" onclick="updateSessionCart('{{ item.key }}', 'increase')">+</button>
                  {% endif %}
                </div>
                
                {# BOT√ìN ELIMINAR #}
                {% if item.id %}
                  {# Usuario autenticado #}
                  <form method="post" action="{% url 'home:carrito_remove' item.id %}" style="margin-top:8px;">
                    {% csrf_token %}
                    <button type="submit" class="btn-eliminar-cart">
                      Eliminar
                    </button>
                  </form>
                {% else %}
                  {# Usuario invitado (sesi√≥n) #}
                  <button type="button" class="btn-eliminar-cart" onclick="removeSessionItem('{{ item.key }}')">
                    Eliminar
                  </button>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div style="background:#fff7e6;border:1px dashed #f0c36d;padding:20px;border-radius:8px;text-align:center;">
            <p style="font-size:1.1rem;margin:0;color:var(--marron-oscuro);">
              <strong>Tu carrito est√° vac√≠o</strong>
            </p>
            <p style="margin:8px 0 16px;color:#666;">¬°Explora nuestro cat√°logo y a√±ade productos!</p>
            <a href="{% url 'home:catalogo' %}" class="add-btn">Ir al cat√°logo</a>
          </div>
        {% endif %}
      </div>
    </section>

    <!-- Resumen SIEMPRE visible -->
    <aside class="order-summary">
      <h4>Resumen de la cesta</h4>
      <div class="summary-row">
        <span>Productos ({{ cantidad_items|default:0 }})</span>
        <strong>{{ subtotal |floatformat:2|default:"0.00" }} ‚Ç¨</strong>
      </div>
      <div class="summary-row">
        <span>Gastos env√≠o</span>
        <span>4,50 ‚Ç¨</span>
      </div>
      <div class="summary-row">
        <span>IVA (21%)</span>
        <span>{{ subtotalIVA|floatformat:2|default:"0.00" }} ‚Ç¨</span>
      </div>
      <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
      <div class="summary-row">
        <strong>Total</strong>
        <strong>{{ total|floatformat:2|default:"0.00" }} ‚Ç¨</strong>
      </div>

      {% if cart_items %}
        <div style="margin-top:16px;">
          {% if user.is_authenticated %}
            <button id="finalizarCompraBtn" type="button" class="step-pill" style="width:100%;padding:14px;font-size:1rem;">
               Finalizar compra
              </button>
          {% else %}
           <a href="{% url 'home:guestBuy' %}" class="step-pill" style="display:block;text-align:center;text-decoration:none;">
              Finalizar compra
            </a>
          {% endif %}
        </div>
      {% endif %}
      
      <p style="margin-top:12px;font-size:0.85rem;color:#666;text-align:center;">
        Pol√≠tica de devoluciones: <strong>no se contemplan devoluciones</strong>.
      </p>
    </aside>
  </div>

  <!-- Secci√≥n de Confirmaci√≥n -->
  <div class="checkout-section">
    <h3 style="color:var(--marron-oscuro);margin-bottom:12px;">Confirmaci√≥n</h3>
    <p style="color:#666;margin-bottom:8px;">
      Al completar el pago recibir√°s un correo electr√≥nico con los datos del producto comprado, importe y direcci√≥n de entrega.
    </p>
    <p style="margin-top:8px;color:var(--gris);font-size:0.9rem;">
      Pol√≠tica de devoluciones: <strong>no se contemplan devoluciones</strong>.
    </p>
  </div>
</div>

<!-- Formularios ocultos para sesi√≥n -->
<form id="sessionUpdateForm" method="post" action="{% url 'home:carrito_add' 0 %}" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="session_key" id="sessionKeyInput">
  <input type="hidden" name="session_action" id="sessionActionInput">
</form>

<style>
  .btn-cantidad-cart {
    width: 36px;
    height: 36px;
    border: 2px solid #ff6f61;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
    color: #ff6f61;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .btn-cantidad-cart:hover {
    background: #ff6f61;
    color: white;
    transform: scale(1.1);
  }
  
  .btn-eliminar-cart {
    background: none;
    border: none;
    color: #dc3545;
    text-decoration: underline;
    cursor: pointer;
    font-size: 0.9rem;
    transition: color 0.2s;
  }
  
  .btn-eliminar-cart:hover {
    color: #a71d2a;
  }
</style>

<script>
    
  document.getElementById("finalizarCompraBtn").addEventListener("click", async () => {

      const endpoint = "{{ SITE_DOMAIN }}/create_checkout_session/";
      
      const cartCode = "{{ codigo_carrito }}";
      const userEmail = "{{ client_email|default:'' }}";

      var body;
  
      if(!userEmail){
         body = {
          cart_code: cartCode
      };
      } else {
         body = {
          cart_code: cartCode,
          email: userEmail
      };
      }
      

      try {
          const response = await fetch(endpoint, {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken")
              },
              body: JSON.stringify(body)
          });

          const json = await response.json();
          console.log(json);

          const redirectUrl = json?.data?.url;

          if (!redirectUrl) {
              console.error("No URL en JSON", json);
              return;
          }

          window.location.href = redirectUrl;

      } catch (error) {
          console.error("Error en fetch:", error);
      }

  });
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function updateSessionCart(key, action) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "home:carrito_update_session_item" %}';
    
    const csrfToken = getCookie('csrftoken');
    
    form.innerHTML = `
      <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
      <input type="hidden" name="key" value="${key}">
      <input type="hidden" name="action" value="${action}">
    `;
    
    document.body.appendChild(form);
    form.submit();
  }

  function removeSessionItem(key) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "home:carrito_remove_session_item" %}';
    
    const csrfToken = getCookie('csrftoken');
    
    form.innerHTML = `
      <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
      <input type="hidden" name="key" value="${key}">
    `;
    
    document.body.appendChild(form);
    form.submit();
  }
</script>
{% endblock %}