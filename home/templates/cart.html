{% extends 'base.html' %}
{% load static %}

{% block title %}Carrito - EntertainPet{% endblock %}

{% block content %}
  <h2 class="mt-4" style="color:var(--marron-oscuro)">Tu cesta</h2>

  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="cart-page">
    <section>
      <div class="cart-list">
        {% if cart_items %}
          {% for item in cart_items %}
            <div class="cart-item">
              <div class="mini-img">
                {% if item.producto.imagenes.first %}
                  <img src="{{ item.producto.imagenes.first.imagen }}" alt="{{ item.producto.nombre }}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">
                {% else %}
                  üñºÔ∏è
                {% endif %}
              </div>
              
              <div class="meta">
                <h5>{{ item.producto.nombre }}</h5>
                
                {% if item.talla_producto %}
                  <p style="color:#666;font-size:0.9rem;margin:4px 0;">
                    Talla: <strong>{{ item.talla_producto.talla }}</strong>
                  </p>
                {% endif %}
                
                <div class="price">{{ item.producto.precio_final }} ‚Ç¨</div>
                <div style="font-size:0.85rem;color:var(--gris);">
                  Subtotal: <strong>{{ item.subtotal }} ‚Ç¨</strong>
                </div>
              </div>
              
              <div class="controls">
                <label style="font-weight:600;margin-bottom:8px;display:block;">Cantidad</label>
                
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                  <form method="post" action="{% url 'home:carrito_update' item.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="decrease">
                    {% if not request.user.is_authenticated %}
                      <input type="hidden" name="key" value="{{ item.key }}">
                    {% endif %}
                    <button type="submit" style="width:32px;height:32px;border:2px solid var(--marron-oscuro);border-radius:6px;background:white;cursor:pointer;font-size:18px;font-weight:bold;color:var(--marron-oscuro);">‚àí</button>
                  </form>
                  
                  <span style="font-size:18px;font-weight:600;min-width:40px;text-align:center;">{{ item.cantidad }}</span>
                  
                  <form method="post" action="{% url 'home:carrito_update' item.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="increase">
                    {% if not request.user.is_authenticated %}
                      <input type="hidden" name="key" value="{{ item.key }}">
                    {% endif %}
                    <button type="submit" style="width:32px;height:32px;border:2px solid var(--marron-oscuro);border-radius:6px;background:white;cursor:pointer;font-size:18px;font-weight:bold;color:var(--marron-oscuro);">+</button>
                  </form>
                </div>
                
                <form method="post" action="{% url 'home:carrito_remove' item.id %}" style="margin-top:8px;">
                  {% csrf_token %}
                  {% if not request.user.is_authenticated %}
                    <input type="hidden" name="key" value="{{ item.key }}">
                  {% endif %}
                  <button type="submit" style="background:none;border:none;color:#dc3545;text-decoration:underline;cursor:pointer;font-size:0.9rem;">
                    Eliminar
                  </button>
                </form>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div style="background:#fff7e6;border:1px dashed #f0c36d;padding:20px;border-radius:8px;text-align:center;">
            <p style="font-size:1.1rem;margin:0;color:var(--marron-oscuro);">
              <strong>Tu carrito est√° vac√≠o</strong>
            </p>
            <p style="margin:8px 0 16px;color:#666;">¬°Explora nuestro cat√°logo y a√±ade productos!</p>
            <a href="{% url 'home:catalogo' %}" class="add-btn">Ir al cat√°logo</a>
          </div>
        {% endif %}
      </div>
    </section>

    {% if cart_items %}
    <aside class="order-summary">
      <h4>Resumen de la cesta</h4>
      <div class="summary-row">
        <span>Productos ({{ cantidad_items }})</span>
        <strong>{{ total|floatformat:2 }} ‚Ç¨</strong>
      </div>
      <div class="summary-row">
        <span>Gastos env√≠o</span>
        <span>4,50 ‚Ç¨</span>
      </div>
      <div class="summary-row">
        <span>IVA (21%)</span>
        <span>{{ total|floatformat:2 }} ‚Ç¨</span>
      </div>
      <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
      <div class="summary-row">
        <strong>Total</strong>
        <strong>{{ total|floatformat:2 }} ‚Ç¨</strong>
      </div>

      <div style="margin-top:16px;">
        {% if user.is_authenticated %}
          <a href="{% url 'home:process_payment' %}" class="step-pill" style="display:block;text-align:center;text-decoration:none;">
            Finalizar compra
          </a>
        {% else %}
          <a href="{% url 'home:guest_checkout' %}" class="step-pill" style="display:block;text-align:center;text-decoration:none;">
            Finalizar compra
          </a>
        {% endif %}
      </div>
      
      <p style="margin-top:12px;font-size:0.85rem;color:#666;text-align:center;">
        Pol√≠tica de devoluciones: <strong>no se contemplan devoluciones</strong>.
      </p>
    </aside>
    {% endif %}
  </div>

{% endblock %}