{% extends 'base.html' %}
{% load static %}

{% block title %}Carrito - EntertainPet{% endblock %}

{% block content %}
  <h2 class="mt-4" style="color:var(--marron-oscuro)">Tu cesta</h2>

  <div class="cart-page">
    <section>
      <div class="cart-list">
        {% if carrito %}
          {% comment %}Intentar recorrer los items del carrito con diferentes nombres conocidos{% endcomment %}
          {% if carrito.items.all %}
            {% for item in carrito.items.all %}
              <div class="cart-item">
                <div class="mini-img">
                  {% if item.producto.image %}
                    <img src="{{ item.producto.image.url }}" alt="{{ item.producto.name }}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">
                  {% else %}
                    üñºÔ∏è
                  {% endif %}
                </div>
                <div class="meta">
                  <h5>{{ item.producto.name }}</h5>
                  <div class="price">{{ item.producto.price }} ‚Ç¨</div>
                </div>
                <div class="controls">
                  <label>Cantidad</label>
                  <form method="post" action="#">
                    {% csrf_token %}
                    <input type="number" name="cantidad" min="0" value="{{ item.cantidad }}">
                    <button class="add-btn" type="submit">Actualizar</button>
                  </form>
                  <form method="post" action="#">
                    {% csrf_token %}
                    <button type="submit" style="background:none;border:none;color:var(--danger);text-decoration:underline;margin-top:6px">Eliminar</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          {% else %}
            {% if carrito.itemcarrito_set.all %}
              {% for item in carrito.itemcarrito_set.all %}
                <div class="cart-item">
                  <div class="mini-img">üñºÔ∏è</div>
                  <div class="meta">
                    <h5>{{ item.producto.name }}</h5>
                    <div class="price">{{ item.producto.price }} ‚Ç¨</div>
                  </div>
                  <div class="controls">
                    <label>Cantidad</label>
                    <input type="number" min="0" value="{{ item.cantidad }}">
                    <a href="{% url 'home:carrito_remove' item.id %}" style="font-size:0.85rem;color:var(--danger);text-decoration:underline;margin-top:6px">Eliminar</a>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p>No hay productos en el carrito.</p>
            {% endif %}
          {% endif %}
        {% else %}
          {% if cart_items %}
            {% for item in cart_items %}
              <div class="cart-item">
                <div class="mini-img">
                  {% if item.producto.imagenes.first %}
                    <img src="{{ item.producto.imagenes.first.imagen }}" alt="{{ item.producto.nombre }}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">
                  {% else %}
                    üñºÔ∏è
                  {% endif %}
                </div>
                <div class="meta">
                  <h5>{{ item.producto.nombre }}</h5>
                  <div class="price">{{ item.producto.precio_final }} ‚Ç¨</div>
                </div>
                <div class="controls">
                  <label>Cantidad</label>
                  <input type="number" min="0" value="{{ item.cantidad }}">
                    <a href="{% url 'home:carrito_remove' item.producto.pk %}" style="font-size:0.85rem;color:var(--danger);text-decoration:underline;margin-top:6px">Eliminar</a>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p>No hay productos en el carrito.</p>
          {% endif %}
        {% endif %}
      </div>
    </section>

    <aside class="order-summary">
  <h4>Resumen de la cesta</h4>
  <div class="summary-row"><span>Productos ({% if carrito %}{{ carrito.items.count }}{% else %}{{ cart_items|length|default:0 }}{% endif %})</span><strong>‚Ç¨ {{ total|default:"0.00" }}</strong></div>
      <div class="summary-row"><span>Gastos env√≠o</span><span>‚Ç¨ 4,50</span></div>
      <div class="summary-row"><span>IVA (21%)</span><span>‚Ç¨ {{ total|default:"0.00" }}</span></div>
      <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
      <div class="summary-row"><strong>Total</strong><strong>‚Ç¨ {{ total|default:"0.00" }}</strong></div>

      <div style="margin-top:12px">
        <a href="#final" class="step-pill">Finalizar compra</a>
      </div>
    </aside>
  </div>

  <section id="final" style="margin-top:18px">
    <div class="checkout-section">
      <h3 style="color:var(--marron-oscuro)">Confirmaci√≥n</h3>
      <p>Al completar el pago recibir√°s un correo electr√≥nico con los datos del producto comprado, importe y direcci√≥n de entrega (esto es una maqueta, en una integraci√≥n real el correo se enviar√≠a autom√°ticamente).</p>
      <p class="small-note" style="margin-top:8px;color:var(--gris)">Pol√≠tica de devoluciones: <strong>no se contemplan devoluciones</strong>.</p>
    </div>
  </section>
{% endblock %}
